---
title: "[MongoDB] Lock Free 알고리즘"
excerpt: "MongoDB의 동시성을 높이기 위한 대표적인 개념인 하자드 포인터와 스킵 리스트에 대해 정리해보았습니다."
#layout: archive
categories:
 - Mongodb
tags:
  - [mongodb]
#permalink: mongodb-first
toc: true
toc_sticky: true
date: 2024-09-15
last_modified_at: 2024-09-15
comments: true
---
### 🚀 MongoDB Lock Free 알고리즘(내부 잠금경합 최소화)
Real MongoDB 서적의 이론을 토대로 MongoDB의 동시성을 높이기 위한 대표적인 개념인 하자드 포인터와 스킵 리스트에 대해 정리해보았습니다. 
<br/>

### 🚀 하자드 포인터
---
이빅션 쓰레드는 한정된 공유캐시의 공간을 확보하기 위해 적절히 제거할 수 있는 페이지를 디스크 영역으로 동기화 시키는 작업을 수행하는데 이 때 하자드 포인터를 참조하여 공유 캐시에 제거 가능한지 여부를 확인합니다. 

사용자 쓰레드는 사용자의 쿼리를 처리하기 위해 WiredTiger 의 공유캐시를 참조할 때 먼저 하자드 포인터에 자신이 참조하는 페이지를 등록합니다. 그리고 사용자 쓰레드가 쿼리를 처리하는 동안 이빅션 쓰레드는 동시에 캐시에서 제거해야 할 데이터 페이지를 골라 캐시에서 삭제하는 작업을 실행합니다. 이때 "이빅션 쓰레드"는 적절히 제거할 수 있는 페이지(자주 사용되지 않는 페이지)를 골라 먼저 하자드 포인터에 등록돼 있는지 확인합니다.

WiredTiger 스토리지 엔진에서 사용할 수 있는 하자드 포인터의 최대 개수는 기본적으로 1,000개로 제한돼 있습니다. 만약 하자드 포인터의 개수가 부족해 WiredTiger 스토리지 엔진의 처리량이 느려진다면 WiredTiger 스토리지 엔진의 옵션을 변경하여 하자드 포인터의 최대 개수를 1,000개 이상으로 설정할 수 있습니다.

MongoDB 서버의 설정 파일을 이용해 하자드 포인터의 개수를 변경하려면, 다음과 같이 `configString` 옵션에 `hazard_max` 옵션을 설정합니다.



```
하자드 포인터 개수 설정 방법
```
<br/>


### 🚀 스킵 리스트
---

!["스킵 리스트"](https://github.com/user-attachments/assets/79f61828-63da-42a2-9ee0-6b9de50e2b35 "스킵 리스트")


스킵 리스트에서 검색은 최상위 레벨에서 시작하여, 현재 노드가 찾고자 하는 값보다 크다면 한 레벨 아래로 이동합니다. 각 레벨에서는 오른쪽으로 노드를 따라가며 검색을 진행합니다. 이를 통해 중간에 있는 많은 노드들을 건너뛰고 빠르게 검색할 수 있습니다.

단순 링크드 리스트의 검색 성능은 O(n)인 반면, 스킵 리스트의 평균 검색 성능은 B-Tree와 같은 O(log(n))입니다. WiredTiger 스토리지 엔진에 사용된 스킵 리스트는 새로운 노드를 추가하기 위해 별도의 잠금을 필요로 하지 않으며, 검색 또한 별도의 잠금을 필요로 하지 않습니다. 

WiredTiger 스토리지 엔진에서는 언두 로그를 스킵 리스트로 관리하는데, 조금 독특하게 데이터 페이지의 레코드를 직접 변경하지 않고 변경된 데이터를 스킵 리스트에 추가합니다. 그리고 사용자 쿼리가 데이터를 읽을 때에는 변경 이력이 저장된 스킵 리스트를 검색하여 원하는 시점의 데이터를 가져갑니다. 이렇게 변경된 내용을 직접 데이터 페이지에 덮어쓰지 않고 별도의 리스트로 관리하는 이유는 쓰기 처리를 빠르게 하기 위함입니다.

기존 RDBMS에서는 데이터가 변경되면 기존 레코드보다 데이터의 크기가 더 커져서 데이터 페이지 내에서 레코드의 위치를 옮겨야 할 수도 있는데, 이런 일련의 과정을 데이터 페이지 내에서 처리하면 이를 처리하는 동안 사용자가 기다려야 합니다. 하지만 WiredTiger 스토리지 엔진에서는 변경되는 내용을 스킵 리스트에 추가하기만 하면 됩니다.


### 🚀 MVCC
---

MVCC(Multi Version Concurrency Control)는 하나의 레코드(도큐먼트)에 대해 여러 개의 버전을 동시에 관리하면서 필요에 따라 적절한 버전을 사용할 수 있게 해주는 기술입니다. 

![WiredTiger 캐시의 데이터 페이지](https://github.com/user-attachments/assets/a1691f95-82dc-44fa-9dc0-dbc3854abd9c "WiredTiger 캐시의 데이터 페이지")

WiredTiger 스토리지 엔진은 메모리상에서 도큐먼트의 변경 이력을 저장하기 위해 스킵 리스트를 사용하는데, 최근의 변경은 스킵 리스트의 앞쪽으로 정렬(위 그림 상 Trx_id 가 높은 순)하여 최근의 데이터를 더 빠르게 검색할 수 있도록 유지합니다.

WiredTiger 스토리지 엔진은 데이터를 직접 덮어쓰지 않고, 새롭게 변경되는 데이터를 스킵 리스트로 관리하면서 각각의 도큐먼트에 대해 여러 개의 버전이 관리되도록 유지합니다. 그런데 이렇게 새로운 버전을 계속 리스트에 추가하기만 하면 상당히 많은 메모리가 추가로 필요하게 될 것입니다. 그래서 WiredTiger 스토리지 엔진은 변경 이력이 늘어나서 memory_page_max 설정 값보다 큰 메모리를 사용하는 페이지를 찾아서 자동으로 디스크에 기록하는 작업(Eviction)을 수행합니다. 이때 리컨실리에이션(Reconciliation) 과정을 거치면서 원래의 데이터 페이지 내용과 변경된 내용을 병합 합니다.



{% assign posts = site.categories.Mongodb %}
{% for post in posts %} {% include archive-single2.html type=page.entries_layout %} {% endfor %}