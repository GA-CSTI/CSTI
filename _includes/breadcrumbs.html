<!-- Check if jekyll-archives is enabled and use original logic if so -->
{% if site.category_archive.type == "jekyll-archives" %}
  {% case site.category_archive.type %}
    {% when "liquid" %}
      {% assign path_type = "#" %}
    {% when "jekyll-archives" %}
      {% assign path_type = nil %}
  {% endcase %}

  {% if page.collection != 'posts' %}
    {% assign path_type = nil %}
    {% assign crumb_path = '/' %}
  {% else %}
    {% assign crumb_path = site.category_archive.path %}
  {% endif %}

  <nav class="breadcrumbs">
    <ol itemscope itemtype="https://schema.org/BreadcrumbList">
      {% assign crumbs = page.url | split: '/' %}
      {% assign i = 1 %}
      {% for crumb in crumbs offset: 1 %}
        {% if forloop.first %}
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ '/' | relative_url }}" itemprop="item"><span itemprop="name">{{ site.data.ui-text[site.locale].breadcrumb_home_label | default: "Home" }}</span></a>
            <meta itemprop="position" content="{{ i }}" />
          </li>
          <span class="sep">{{ site.data.ui-text[site.locale].breadcrumb_separator | default: "/" }}</span>
        {% endif %}
        {% if forloop.last %}
          <li class="current"{% if page.locale %} lang="{{ page.locale }}"{% endif %}>{{ page.title }}</li>
        {% else %}
          {% assign i = i | plus: 1 %}
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ crumb | downcase | replace: '%20', '-' | prepend: path_type | prepend: crumb_path | relative_url }}" itemprop="item"><span itemprop="name">{{ crumb | url_decode | replace: '-', ' ' | capitalize }}</span></a>
            <meta itemprop="position" content="{{ i }}" />
          </li>
          <span class="sep">{{ site.data.ui-text[site.locale].breadcrumb_separator | default: "/" }}</span>
        {% endif %}
      {% endfor %}
    </ol>
  </nav>
{% else %}
  <!-- Custom logic: use page titles where available, else uppercase URL parts -->
  <nav class="breadcrumbs">
    <ol itemscope itemtype="https://schema.org/BreadcrumbList">
      <!-- Home -->
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="{{ '/' | relative_url }}" itemprop="item"><span itemprop="name">{{ site.data.ui-text[site.locale].breadcrumb_home_label | default: "Home" }}</span></a>
        <meta itemprop="position" content="1" />
      </li>
      <span class="sep">{{ site.data.ui-text[site.locale].breadcrumb_separator | default: "/" }}</span>

      <!-- Split URL into parts, filter out empty ones -->
      {% assign url_parts = page.url | split: '/' | where_exp: "item", "item.size > 0" %}
      {% assign crumb_path = '' %}
      {% assign position = 2 %}
      <!-- Define all_pages once, outside the loop -->
      {% assign all_pages = site.pages | concat: site.documents %}
      {% for part in url_parts %}
        {% assign crumb_path = crumb_path | append: '/' | append: part %}
        {% if forloop.last %}
          <!-- Current page/post title -->
          <li class="current"{% if page.locale %} lang="{{ page.locale }}"{% endif %}>{{ page.title }}</li>
        {% else %}
          <!-- Upper levels: check for a matching page or document -->
          {% assign found = false %}
          {% for site_page in all_pages %}
            {% if site_page.url == crumb_path or site_page.url == crumb_path | append: '/' %}
              {% assign found = true %}
              <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                <a href="{{ site_page.url | relative_url }}" itemprop="item"><span itemprop="name">{{ site_page.title | upcase }}</span></a>
                <meta itemprop="position" content="{{ position }}" />
              </li>
              <span class="sep">{{ site.data.ui-text[site.locale].breadcrumb_separator | default: "/" }}</span>
              {% assign position = position | plus: 1 %}
              {% break %}
            {% endif %}
          {% endfor %}
          {% if found == false %}
            {% if site.breadcrumb_fallback_style == "titlecase" %}
              {% assign display = part | replace: '-', ' ' | capitalize %}
            {% elsif site.breadcrumb_fallback_style == "uppercase" %}
              {% assign display = part | replace: '-', ' ' | upcase %}
            {% else %}
              {% assign display = part | replace: '-', ' ' %}
            {% endif %}
            <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
              <a href="{{ crumb_path | relative_url }}" itemprop="item"><span itemprop="name">{{ display }}</span></a>
              <meta itemprop="position" content="{{ position }}" />
            </li>
            <span class="sep">{{ site.data.ui-text[site.locale].breadcrumb_separator | default: "/" }}</span>
            {% assign position = position | plus: 1 %}
          {% endif %}
        {% endif %}
      {% endfor %}
    </ol>
  </nav>
{% endif %}
